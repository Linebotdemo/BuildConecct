<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ—¥æœ¬ç‰ˆ Smart Shelter</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />

  <!-- ã‚«ã‚¹ã‚¿ãƒ  CSS -->
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
</head>
<body>
  <!-- ç”»åƒæ‹¡å¤§ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-transparent border-0">
        <img id="modalImg" src="" class="img-fluid rounded" alt="æ‹¡å¤§ç”»åƒ">
      </div>
    </div>
  </div>

  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>æ—¥æœ¬ç‰ˆ Smart Shelter</h1>
      <a href="/login" class="btn btn-outline-primary">è‡ªæ²»ä½“ç”¨ãƒ­ã‚°ã‚¤ãƒ³</a>
    </div>

    <!-- æ¤œç´¢ -->
    <div class="mb-4">
      <h2>é¿é›£æ‰€æ¤œç´¢</h2>
      <input
        type="text"
        id="search"
        placeholder="é¿é›£æ‰€åã€ä½æ‰€ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢"
        class="form-control"
      />
    </div>

    <!-- ç½å®³è­¦å ± -->
    <div id="alert-section" class="alert-section">
      <p>èª­ã¿è¾¼ã¿ä¸­â€¦</p>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="mb-4">
      <h3>ãƒ•ã‚£ãƒ«ã‚¿</h3>
      <form id="filter-form" class="d-flex flex-wrap align-items-center gap-3">
        <!-- å±æ€§ãƒã‚§ãƒƒã‚¯ -->
        {% for name, label in [
           ['pets_allowed', 'ãƒšãƒƒãƒˆå¯'],
           ['barrier_free', 'ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼'],
           ['toilet_available', 'ãƒˆã‚¤ãƒ¬'],
           ['food_available', 'é£Ÿæ–™æä¾›'],
           ['medical_available', 'åŒ»ç™‚å¯¾å¿œ'],
           ['wifi_available', 'Wi-Fi'],
           ['charging_available', 'å……é›»è¨­å‚™']
         ] %}
          <div class="form-check form-check-inline">
            <input class="form-check-input"
                   type="checkbox"
                   name="{{ name }}"
                   id="filter-{{ name }}"
            >
            <label class="form-check-label" for="filter-{{ name }}">{{ label }}</label>
          </div>
        {% endfor %}

        <!-- çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div class="form-group d-flex align-items-center ms-3">
          <label for="filter-status" class="me-2 mb-0">çŠ¶æ…‹:</label>
          <select id="filter-status" class="form-select form-select-sm w-auto">
            <option value="">å…¨ã¦</option>
            <option value="open">é–‹è¨­ä¸­</option>
            <option value="closed">é–‰é–</option>
          </select>
        </div>

        <!-- è·é›¢ãƒ•ã‚£ãƒ«ã‚¿ -->
        <div class="form-group d-flex align-items-center ms-3">
          <label for="filter-distance" class="me-2 mb-0">ç¯„å›²:</label>
          <select id="filter-distance" class="form-select form-select-sm w-auto">
            <option value="0">å…¨ã¦</option>
            <option value="5">5kmä»¥å†…</option>
            <option value="10">10kmä»¥å†…</option>
            <option value="20">20kmä»¥å†…</option>
          </select>
        </div>
      </form>
    </div>

    <!-- é¿é›£æ‰€ä¸€è¦§ -->
    <div class="mb-4">
      <h3>é¿é›£æ‰€ä¸€è¦§</h3>
      <div id="shelter-list">
        {% for s in shelters %}
          <div class="shelter card mb-3 p-3" data-id="{{ s.id }}">
            <h4>{{ s.name }}</h4>
            <p>ä½æ‰€: {{ s.address }}</p>
            <p>é€£çµ¡å…ˆ: {{ s.contact or 'ãªã—' }}</p>
            <p>é‹å–¶å›£ä½“: {{ s.operator or 'ãªã—' }}</p>
            <p>çŠ¶æ…‹: {{ 'é–‹è¨­ä¸­' if s.status=='open' else 'é–‰é–' }}</p>
            <p>å®šå“¡: {{ s.capacity }}äºº</p>
            <p>ç¾åœ¨äººæ•°: {{ s.current_occupancy }}äºº ({{ (s.current_occupancy/s.capacity*100)|round(1) }}%)</p>
            
            <!-- å±æ€§ã‚¿ã‚° -->
            <div class="tags mb-2">
              {% set attribute_labels = {
                'pets_allowed': ['ãƒšãƒƒãƒˆå¯', 'ğŸ¾'],
                'barrier_free': ['ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼', 'â™¿'],
                'toilet_available': ['ãƒˆã‚¤ãƒ¬', 'ğŸš»'],
                'food_available': ['é£Ÿæ–™', 'ğŸ½ï¸'],
                'medical_available': ['åŒ»ç™‚', 'ğŸ¥'],
                'wifi_available': ['Wi-Fi', 'ğŸ“¶'],
                'charging_available': ['å……é›»', 'ğŸ”Œ']
              } %}
              {% set has_attributes = False %}
              {% for key, [label, icon] in attribute_labels.items() %}
                {% if s.attributes and s.attributes[key] %}
                  <span class="badge bg-info me-1">{{ icon }} {{ label }}</span>
                  {% set has_attributes = True %}
                {% endif %}
              {% endfor %}
              {% if not has_attributes %}
                <span class="badge bg-secondary">å±æ€§ãªã—</span>
              {% endif %}
            </div>

            <div class="occupancy-bar mb-2">
              <div class="occupancy-fill {% if s.current_occupancy/s.capacity>=0.8 %}warning{% endif %}"
                   style="width: {{ (s.current_occupancy/s.capacity*100) }}%;"></div>
            </div>

            <canvas id="chart-{{ s.id }}" height="50"></canvas>

            {% if s.photos %}
              <div class="photo-gallery mb-2">
                {% for photo in s.photos %}
                  <img src="{{ photo }}"
                       class="photo-preview me-1 rounded"
                       style="width:100px; cursor:pointer;"
                       alt="ã‚µãƒ ãƒã‚¤ãƒ«">
                {% endfor %}
              </div>
            {% endif %}

            <button class="favorite-btn btn btn-outline-secondary me-1"
                    onclick="toggleFavorite({{ s.id }})">
              â˜† ãŠæ°—ã«å…¥ã‚Šç™»éŒ²
            </button>
            <a href="https://www.google.com/maps/dir/?api=1&destination={{ s.latitude }},{{ s.longitude }}"
               target="_blank"
               class="btn btn-outline-success">
              ãƒ«ãƒ¼ãƒˆæ¡ˆå†…
            </a>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- ãƒãƒƒãƒ— -->
    <div class="mb-4">
      <h3>é¿é›£æ‰€ãƒãƒƒãƒ—</h3>
      <div id="map" style="height:400px;"></div>
    </div>
  </div>

  <!-- JSãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/script.js" defer></script>
</body>
</html>